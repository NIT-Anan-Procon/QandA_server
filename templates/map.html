<html>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
        <style>
            html { width: 100%; height: 100%; }
            body { width: 100%; height: 100%; margin: 0; }
            #map { width: 70%; height: 60%; }
            .leaflet-marker-icon-color-blue   { -webkit-filter: hue-rotate( 30deg); filter: hue-rotate( 30deg); }
            .leaflet-marker-icon-color-pink   { -webkit-filter: hue-rotate( 90deg); filter: hue-rotate( 90deg); }
            .leaflet-marker-icon-color-red    { -webkit-filter: hue-rotate(150deg); filter: hue-rotate(150deg); }
            .leaflet-marker-icon-color-yellow { -webkit-filter: hue-rotate(210deg); filter: hue-rotate(210deg); }
            .leaflet-marker-icon-color-green  { -webkit-filter: hue-rotate(270deg); filter: hue-rotate(270deg); }
            .leaflet-marker-icon-color-alua   { -webkit-filter: hue-rotate(330deg); filter: hue-rotate(330deg); }

            table.example{
                width:920px;
                margin-left: 20;
                border:1px #c0c0c0 solid;
                border-collapse: collapse;
                front-size:80%;
            }
            table.example caption{
            padding-bottom: 5px;
            }

            table.example th,
            table.example td{
                padding: 6px 8px;
                border: 1px #c0c0c0 solid;
            }

            table.example colgroup.item{
                background-color: #fffce7;
            }
            table.example colgroup.data{
                background-color: #ffffff;
            }
            table.example thead th{
                background-color: #deefff;
            }
        </style>
    </head>

    <body>
        <div id="map"></div>
        <button id="buttonBackToCenter">back to center</button>

        <table class="example">

            <colgroup class="item"></colgroup>
            <colgroup span="4" class="data"></colgroup>

            <tbody>
                <tr>
                    <td>ID</th>
                    <td id="table_id"></th>
                </tr>
                <tr>
                    <td>緯度経度</th>
                    <td id="table_latlng"></th>
                </tr>
                <tr>
                    <td>状態</td>
                    <td id="table_state"></td>
                </tr>
                <tr>
                    <td>問診記録</td>
                    <td id="table_records" style="word-wrap:break-word;">
                        <ul id="table_records_list" style="list-style:none;" />
                    </td>
                </tr>
                <tr>
                    <td>応急手当</td>
                    <td id="table_cares">
                        <ul id="table_cares_list" style="list-style:none;" />
                    </td>
                </td>
            </tbody>
        </table>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

        <script>
            var mapCenterLatLng = ['{{ latlng[0] }}', '{{ latlng[1] }}'];


            //地図タイルの設定
            var map = L.map('map')
            .setView(
                mapCenterLatLng,
                13
            );

            L.tileLayer(
                'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', 
                { attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors' }
            ).addTo(map);

            //markerとpopupの設定
            var marker = L.marker(
                mapCenterLatLng,
                { title: "marker-title" }
            )
            .addTo(map)
            .on("click", function(){
                alert('Your FireStation');
            });

            //iconの要素にClassを追加
            L.DomUtil.addClass( marker._icon, 'leaflet-marker-icon-color-pink' );

            function backToCenter(){
                map.panTo(mapCenterLatLng);
            }

            function latlng2list(latlng){
                var latlng_list = latlng.split("/");
                var lat = Number(latlng_list[0]);
                var lng = Number(latlng_list[1]);
                return [lat, lng];
            }
     
            var table = document.createElement( 'table' );

            document.querySelector('#buttonBackToCenter').onclick=function(){ backToCenter() };

            var interviews = new Array();
            var interviewmessages = new Array();

            function add_marker(patient_id, state, latlng, records, cares, require_encode){
                var icon = "";
                switch (state){
                    case 1:
                        icon = 'leaflet-marker-icon-color-blue';
                        break;
                    case 2:
                        icon = 'leaflet-marker-icon-color-yellow';
                        break;
                    case 3:
                        icon = 'leaflet-marker-icon-color-red';
                        break;
                }

                var records_ = new Array();

                //encode is required when records is sent via socketio
                if(require_encode){
                    $("#table_records").text("encode");
                    for(var i = 0; i < records.length; i++){
                        var record = records[i];
                        var text = "";
                        for(var j = 0; j < record.length; j++){
                            text += String(record[j]);
                        }
                        if (i == records.length-1){
                            break;
                        } else {

                        }

                        records_.push(text);
                    }
                } else {
                    records_ = records.split(":");
                }




                var marker = L.marker(
                    latlng2list(latlng),
                    { title: "marker-title" }
                )
                .addTo(map)
                .on("click", function(){
                    $("#table_id").text(String(patient_id));
                    $("#table_latlng").text(String(latlng));
                    $("#table_state").text(String(state));
                    //$("#table_cares").text(cares);


                    var ul = document.getElementById("table_cares_list");
                    $("#table_cares_list").empty('');
                    
                    cares_list = cares.split(":");
                    for (i = 0; i < cares_list.length; i++){
                        var care = cares_list[i];
                        var li = document.createElement('li');
                        li.appendChild(document.createTextNode(care));
                        ul.appendChild(li);

                    }

                    var ul = document.getElementById("table_records_list");
                    $("#table_records_list").empty('');

                    for (i = 0; i < records_.length; i++){
                        var record = records_[i]
                        var li = document.createElement('li');
                        li.appendChild(document.createTextNode(record));
                        ul.appendChild(li);
                    }

                });
                L.DomUtil.addClass( marker._icon, icon );

                interviews[patient_id] = marker
                interviewmessages[patient_id] = {"patient_id":patient_id, "state":state, "latlng":latlng, "records":text}

            }

            function delete_marker(msg){
                var marker = interviews[msg.patient_id]
                map.removeLayer(marker);
            }

            // add marker when it opens
            {% for marker in markers %}
                add_marker({{ marker.patient_id }}, {{ marker.state }}, '{{ marker.latlng }}', '{{ marker.interview_records }}', '{{ marker.cares }}', false)
            {% endfor %}

            namespace = "/map"
            var socket = io.connect('//' + document.domain + ':' + location.port + namespace);

            socket.on('add new marker', function(msg) {
                add_marker(
                    msg.patient_id,
                    msg.state,
                    msg.latlng,
                    msg.interview_records,
                    msg.cares,
                    true
                )
            });

            socket.on('delete a marker', function(msg) {
                delete_marker(msg)
            });

            socket.on('change the state', function(new_msg) {
                delete_marker(new_msg)
                msg = interviewmessages[new_msg.patient_id]
                add_marker(
                    msg.patient_id,
                    new_msg.state,
                    msg.latlng,
                    new_msg.records,
                    new_msg.cares,
                    false
                )
            });

            socket.on('delete all markers', function(msgs){
                for(var i = 0; i < msgs.patient_ids.length; i++){
                    var msg = msgs.patient_ids[i];
                    delete_marker(msg)
                }
            });
            
        </script>
    </body>
</html>